#!/bin/bash

# This script is almost entirely based on
# https://github.com/concourse/bin/blob/master/ci/build-linux and
# https://github.com/concourse/bin/blob/master/scripts/build-linux

set -e -u -x

mkdir -p ${BOSH_INSTALL_TARGET}/src

cp -a . ${BOSH_INSTALL_TARGET}/src/.

export GOROOT=$(readlink -nf /var/vcap/packages/golang_1.7.1)
export GOPATH=$BOSH_INSTALL_TARGET
export PATH=$GOROOT/bin:$PATH:$GOPATH/bin

# go get github.com/jteeuwen/go-bindata/go-bindata

LINUX_ASSETS=$PWD/linux
BOSH_PACKAGES_DIR=/var/vcap/packages # TODO is there a better way?

rm -rf $LINUX_ASSETS
mkdir -p $LINUX_ASSETS

mkdir -p $LINUX_ASSETS/bin

# go-bindata does weird stuff with symlinks. we only care about iptables anyway
# rm -rf $LINUX_ASSETS/iptables/sbin/*
# rm -rf $LINUX_ASSETS/iptables/bin
# cp -aL /opt/static-assets/iptables/sbin/iptables $LINUX_ASSETS/iptables/sbin/iptables

go install github.com/jteeuwen/go-bindata/go-bindata/
go install code.cloudfoundry.org/guardian/cmd/init/
go install code.cloudfoundry.org/guardian/cmd/dadoo/

pushd code.cloudfoundry.org/guardian/rundmc/nstar
  make
  mv nstar $LINUX_ASSETS/bin
popd

# collect binaries
cp ${BOSH_PACKAGES_DIR}/runc/bin/runc $LINUX_ASSETS/bin
cp ${BOSH_PACKAGES_DIR}/tar/tar $LINUX_ASSETS/bin
cp ${BOSH_PACKAGES_DIR}/iptables/sbin/iptables $LINUX_ASSETS/bin
cp ${GOPATH}/bin/{init,dadoo} $LINUX_ASSETS/bin


go-bindata -nomemcopy -pkg bindata -o ${GOPATH}/src/code.cloudfoundry.org/gdn/bindata/bindata.go linux/...

# must be built with 'daemon' flag because of docker packages :|
go build \
  -tags daemon \
  -o binary/gdn \
  code.cloudfoundry.org/gdn/cmd/gdn

cp binary/gdn ${BOSH_INSTALL_TARGET}/bin
